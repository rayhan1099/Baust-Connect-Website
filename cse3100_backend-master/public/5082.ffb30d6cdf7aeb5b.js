"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5082],{5082:(ze,b,c)=>{c.r(b),c.d(b,{ChatlistPageModule:()=>Ve});var m=c(9808),p=c(4182),a=c(2159),v=c(2281),r=c(1269),R=c(5722),C=c(7221),A=c(520),L=c(4376),N=c(1188),y=c(8555);let D=(()=>{class n{constructor(e,i,o,s){this.httpClient=e,this.httpconfig=i,this.storageService=o,this.loaderService=s,this.apiRoot=R.I.apiUrl,this.path="chat",this.csrf="sanctum/csrf-cookie",this.siteRoot=R.I.siteRoot,this.completePath=this.apiRoot+this.path}send(e,i=null){return this.httpClient.post(this.apiRoot+this.path,e).pipe((0,C.K)(this.httpconfig.handleError("send message error occurred")))}receive(e,i=null){return this.httpClient.post(this.apiRoot+this.path+"/get",e).pipe((0,C.K)(this.httpconfig.handleError("get message error occurred")))}chatList(){return this.httpClient.get(this.apiRoot+this.path).pipe((0,C.K)(this.httpconfig.handleError("get chat list error occurred")))}}return n.\u0275fac=function(e){return new(e||n)(r.LFG(A.eN),r.LFG(L.N),r.LFG(N.V),r.LFG(y.D))},n.\u0275prov=r.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();function B(n,t){1&n&&(r.TgZ(0,"ion-list")(1,"ion-item")(2,"h1"),r._uU(3,"NO ITEM FOUND"),r.qZA()()())}function Z(n,t){if(1&n&&(r.TgZ(0,"ion-item")(1,"ion-avatar"),r._UZ(2,"img",5),r.qZA(),r.TgZ(3,"ion-label",6)(4,"h2"),r._uU(5),r.qZA(),r.TgZ(6,"h3",7),r._uU(7),r.qZA(),r.TgZ(8,"p",8),r._uU(9),r.qZA()()()),2&n){const e=t.$implicit,i=r.oxw();r.xp6(3),r.MGl("routerLink","/messages/",null==e||null==e.sender?null:e.sender.id,""),r.xp6(2),r.Oqu(null==e||null==e.sender?null:e.sender.full_name),r.xp6(2),r.Oqu(null==e?null:e.content),r.xp6(2),r.Oqu(i.date2ago(null==e?null:e.created_at))}}let j=(()=>{class n{constructor(e){this.chatService=e,this.chats=[]}ngOnInit(){this.chatService.chatList().subscribe(e=>{if(e&&"ok"==e.status)for(let i in e.data)this.chats.push(e.data[i])})}date2ago(e){let i=Math.floor(Date.now()/1e3-Date.parse(e)/1e3),o=Math.floor(i/31536e3);return o>1?o+"y":(o=Math.floor(i/2592e3),o>1?o+"m":(o=Math.floor(i/86400),o>=1?o+"d":(o=Math.floor(i/3600),o>=1?o+"h":(o=Math.floor(i/60),o>1?o+"m ":Math.floor(i)+"s"))))}}return n.\u0275fac=function(e){return new(e||n)(r.Y36(D))},n.\u0275cmp=r.Xpm({type:n,selectors:[["app-chatlist"]],decls:13,vars:2,consts:[["color","primary"],["slot","start"],["size-lg","4","size-md","4","size-sm","4","size-xl","4","size-xs","12"],[4,"ngIf"],[4,"ngFor","ngForOf"],["src","../../../../assets/shapes.svg"],[3,"routerLink"],[2,"color","darkgray"],[2,"color","lightgray"]],template:function(e,i){1&e&&(r.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1),r._UZ(3,"ion-menu-button"),r.qZA(),r.TgZ(4,"ion-title"),r._uU(5,"messages"),r.qZA()()(),r.TgZ(6,"ion-content")(7,"ion-grid")(8,"ion-row")(9,"ion-col",2),r.YNc(10,B,4,0,"ion-list",3),r.TgZ(11,"ion-list"),r.YNc(12,Z,10,4,"ion-item",4),r.qZA()()()()()),2&e&&(r.xp6(10),r.Q6J("ngIf",(null==i.chats?null:i.chats.length)<1),r.xp6(2),r.Q6J("ngForOf",i.chats))},directives:[a.Gu,a.sr,a.Sm,a.fG,a.wd,a.W2,a.jY,a.Nd,a.wI,m.O5,a.q_,a.Ie,m.sg,a.BJ,a.Q$,a.YI,v.rH],styles:[".sender[_ngcontent-%COMP%], .receiver[_ngcontent-%COMP%]{border-radius:10px}"]}),n})();var U=c(8091),T=c(8929),W=c(2916),O=c(2654);class Y extends O.w{constructor(t,e){super()}schedule(t,e=0){return this}}class _ extends Y{constructor(t,e){super(t,e),this.scheduler=t,this.work=e,this.pending=!1}schedule(t,e=0){if(this.closed)return this;this.state=t;const i=this.id,o=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(o,i,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(o,this.id,e),this}requestAsyncId(t,e,i=0){return setInterval(t.flush.bind(t,this),i)}recycleAsyncId(t,e,i=0){if(null!==i&&this.delay===i&&!1===this.pending)return e;clearInterval(e)}execute(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const i=this._execute(t,e);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(t,e){let o,i=!1;try{this.work(t)}catch(s){i=!0,o=!!s&&s||new Error(s)}if(i)return this.unsubscribe(),o}_unsubscribe(){const t=this.id,e=this.scheduler,i=e.actions,o=i.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==o&&i.splice(o,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null}}let k=(()=>{class n{constructor(e,i=n.now){this.SchedulerAction=e,this.now=i}schedule(e,i=0,o){return new this.SchedulerAction(this,e).schedule(o,i)}}return n.now=()=>Date.now(),n})();class g extends k{constructor(t,e=k.now){super(t,()=>g.delegate&&g.delegate!==this?g.delegate.now():e()),this.actions=[],this.active=!1,this.scheduled=void 0}schedule(t,e=0,i){return g.delegate&&g.delegate!==this?g.delegate.schedule(t,e,i):super.schedule(t,e,i)}flush(t){const{actions:e}=this;if(this.active)return void e.push(t);let i;this.active=!0;do{if(i=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,i){for(;t=e.shift();)t.unsubscribe();throw i}}}const G=new g(_);var H=c(6688);function I(n){return!(0,H.k)(n)&&n-parseFloat(n)+1>=0}var E=c(2866);function Q(n){const{index:t,period:e,subscriber:i}=n;if(i.next(t),!i.closed){if(-1===e)return i.complete();n.index=t+1,this.schedule(n,e)}}const K=new class $ extends g{}(class q extends _{constructor(t,e){super(t,e),this.scheduler=t,this.work=e}schedule(t,e=0){return e>0?super.schedule(t,e):(this.delay=e,this.state=t,this.scheduler.flush(this),this)}execute(t,e){return e>0||this.closed?super.execute(t,e):this._execute(t,e)}requestAsyncId(t,e,i=0){return null!==i&&i>0||null===i&&this.delay>0?super.requestAsyncId(t,e,i):t.flush(this)}});var V=c(3489),X=c(8896),ee=c(1086),te=c(1737);class f{constructor(t,e,i){this.kind=t,this.value=e,this.error=i,this.hasValue="N"===t}observe(t){switch(this.kind){case"N":return t.next&&t.next(this.value);case"E":return t.error&&t.error(this.error);case"C":return t.complete&&t.complete()}}do(t,e,i){switch(this.kind){case"N":return t&&t(this.value);case"E":return e&&e(this.error);case"C":return i&&i()}}accept(t,e,i){return t&&"function"==typeof t.next?this.observe(t):this.do(t,e,i)}toObservable(){switch(this.kind){case"N":return(0,ee.of)(this.value);case"E":return(0,te._)(this.error);case"C":return(0,X.c)()}throw new Error("unexpected notification kind value")}static createNext(t){return void 0!==t?new f("N",t):f.undefinedValueNotification}static createError(t){return new f("E",void 0,t)}static createComplete(){return f.completeNotification}}f.completeNotification=new f("C"),f.undefinedValueNotification=new f("N",void 0);class w extends V.L{constructor(t,e,i=0){super(t),this.scheduler=e,this.delay=i}static dispatch(t){const{notification:e,destination:i}=t;e.observe(i),this.unsubscribe()}scheduleMessage(t){this.destination.add(this.scheduler.schedule(w.dispatch,this.delay,new ne(t,this.destination)))}_next(t){this.scheduleMessage(f.createNext(t))}_error(t){this.scheduleMessage(f.createError(t)),this.unsubscribe()}_complete(){this.scheduleMessage(f.createComplete()),this.unsubscribe()}}class ne{constructor(t,e){this.notification=t,this.destination=e}}var re=c(5279),oe=c(5283);class se extends T.xQ{constructor(t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i){super(),this.scheduler=i,this._events=[],this._infiniteTimeWindow=!1,this._bufferSize=t<1?1:t,this._windowTime=e<1?1:e,e===Number.POSITIVE_INFINITY?(this._infiniteTimeWindow=!0,this.next=this.nextInfiniteTimeWindow):this.next=this.nextTimeWindow}nextInfiniteTimeWindow(t){if(!this.isStopped){const e=this._events;e.push(t),e.length>this._bufferSize&&e.shift()}super.next(t)}nextTimeWindow(t){this.isStopped||(this._events.push(new le(this._getNow(),t)),this._trimBufferThenGetEvents()),super.next(t)}_subscribe(t){const e=this._infiniteTimeWindow,i=e?this._events:this._trimBufferThenGetEvents(),o=this.scheduler,s=i.length;let l;if(this.closed)throw new re.N;if(this.isStopped||this.hasError?l=O.w.EMPTY:(this.observers.push(t),l=new oe.W(this,t)),o&&t.add(t=new w(t,o)),e)for(let d=0;d<s&&!t.closed;d++)t.next(i[d]);else for(let d=0;d<s&&!t.closed;d++)t.next(i[d].value);return this.hasError?t.error(this.thrownError):this.isStopped&&t.complete(),l}_getNow(){return(this.scheduler||K).now()}_trimBufferThenGetEvents(){const t=this._getNow(),e=this._bufferSize,i=this._windowTime,o=this._events,s=o.length;let l=0;for(;l<s&&!(t-o[l].time<i);)l++;return s>e&&(l=Math.max(l,s-e)),l>0&&o.splice(0,l),o}}class le{constructor(t,e){this.time=t,this.value=e}}class ce{constructor(t,e){this.count=t,this.source=e}call(t,e){return e.subscribe(new de(t,this.count,this.source))}}class de extends V.L{constructor(t,e,i){super(t),this.count=e,this.source=i}error(t){if(!this.isStopped){const{source:e,count:i}=this;if(0===i)return super.error(t);i>-1&&(this.count=i-1),e.subscribe(this._unsubscribeAndRecycle())}}}var he=c(2474),x=c(1177);class fe{constructor(t){this.notifier=t}call(t,e){const i=new pe(t),o=(0,x.ft)(this.notifier,new x.IY(i));return o&&!i.seenValue?(i.add(o),e.subscribe(i)):i}}class pe extends x.Ds{constructor(t){super(t),this.seenValue=!1}notifyNext(){this.seenValue=!0,this.complete()}notifyComplete(){}}var ge=c(7053);function me(n,t){if(1&n&&(r.TgZ(0,"ion-label",10),r._uU(1),r.qZA()),2&n){const e=r.oxw().$implicit;r.xp6(1),r.Oqu(null==e?null:e.content)}}function ve(n,t){if(1&n&&(r.TgZ(0,"ion-label",11),r._uU(1),r.qZA()),2&n){const e=r.oxw().$implicit;r.xp6(1),r.Oqu(null==e?null:e.content)}}function _e(n,t){if(1&n&&(r.TgZ(0,"ion-item"),r.YNc(1,me,2,1,"ion-label",8),r.YNc(2,ve,2,1,"ion-label",9),r.qZA()),2&n){const e=t.$implicit,i=r.oxw();r.xp6(1),r.Q6J("ngIf",e.from==i.from.id),r.xp6(1),r.Q6J("ngIf",e.from==i.receiver.id)}}const we=[{path:"",component:j},{path:":id",component:(()=>{class n{constructor(e,i,o,s,l,d){this.authService=e,this.loaderService=i,this.activeRoute=o,this.router=s,this.fb=l,this.chatService=d,this.messages=[],this.receiver=new U.D,this.stopPolling=new T.xQ,this.force_disable=!1,this.rxjs_interval=function J(n=0,t,e){let i=-1;return I(t)?i=Number(t)<1?1:Number(t):(0,E.K)(t)&&(e=t),(0,E.K)(e)||(e=G),new W.y(o=>{const s=I(n)?n:+n-e.now();return e.schedule(Q,s,{index:0,period:i,subscriber:o})})}(1,2e3).pipe(function ae(n=-1){return t=>t.lift(new ce(n,t))}(),(0,he.B)(),function ue(n){return t=>t.lift(new fe(n))}(this.stopPolling))}ngOnInit(){const e=this.activeRoute.snapshot.paramMap.get("id");this.authService.getProfileFromServer(e).subscribe(i=>{i&&"ok"==i.status&&(this.receiver=i.data.info,this.profile_full_body=i.data,this.loadOldMessages())}),this.authService.getProfile().then(i=>{this.from=i}),this.message_box=this.fb.group({content:["",[p.kI.required,p.kI.minLength(4),p.kI.maxLength(249)]]}),this.rxjs_interval.subscribe(i=>this.receive("fetch msg: "+i))}send(){var e,i;this.force_disable=!0,this.chatService.send({to:null===(e=this.receiver)||void 0===e?void 0:e.id,content:null===(i=this.message_box.value)||void 0===i?void 0:i.content}).subscribe(o=>{o&&"ok"==o.status&&(this.pushToList(o.data,!0),this.message_box.reset())}),this.force_disable=!1}receive(e=null){var i,o,s,l;let d=(null===(i=this.messages)||void 0===i?void 0:i.length)>0?null===(s=null==this?void 0:this.messages[(null===(o=this.messages)||void 0===o?void 0:o.length)-1])||void 0===s?void 0:s.id:null;return this.chatService.receive({to:null===(l=this.receiver)||void 0===l?void 0:l.id,msg_id:d}).subscribe(h=>{if(h&&"ok"==h.status)for(let u of h.data)this.pushToList(u,!!e)}),new se(1)}loadOldMessages(){this.receive()}ngOnDestroy(){this.stopPolling.next()}pushToList(e,i=!1){for(let o of this.messages)if(o.id==e.id)return;i?this.messages.push(e):this.messages.unshift(e)}}return n.\u0275fac=function(e){return new(e||n)(r.Y36(ge.$),r.Y36(y.D),r.Y36(v.gz),r.Y36(v.F0),r.Y36(p.qu),r.Y36(D))},n.\u0275cmp=r.Xpm({type:n,selectors:[["app-chat"]],decls:24,vars:5,consts:[["color","primary"],["slot","start"],["size-lg","4","size-md","3","size-xs","12"],[4,"ngFor","ngForOf"],[3,"formGroup","ngSubmit"],["formControlName","content","placeholder","Type message...","type","text","auto-grow","true"],["type","submit",3,"disabled"],["name","send"],["class","ion-text-end",4,"ngIf"],["class","ion-text-start",4,"ngIf"],[1,"ion-text-end"],[1,"ion-text-start"]],template:function(e,i){1&e&&(r.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1),r._UZ(3,"ion-menu-button"),r.qZA(),r.TgZ(4,"ion-title"),r._uU(5),r.qZA()()(),r.TgZ(6,"ion-content")(7,"ion-grid")(8,"ion-row"),r._UZ(9,"ion-col",2),r.TgZ(10,"ion-col")(11,"ion-list"),r.YNc(12,_e,3,2,"ion-item",3),r.qZA()()()()(),r.TgZ(13,"ion-footer")(14,"ion-grid")(15,"ion-row"),r._UZ(16,"ion-col",2),r.TgZ(17,"ion-col")(18,"form",4),r.NdJ("ngSubmit",function(){return i.send()}),r.TgZ(19,"ion-item"),r._UZ(20,"ion-textarea",5),r.TgZ(21,"ion-button",6),r._uU(22,"Send "),r._UZ(23,"ion-icon",7),r.qZA()()()()()()()),2&e&&(r.xp6(5),r.AsE("to: ",null==i.receiver?null:i.receiver.full_name,"[",null==i.receiver?null:i.receiver.student_id,"]"),r.xp6(7),r.Q6J("ngForOf",i.messages),r.xp6(6),r.Q6J("formGroup",i.message_box),r.xp6(3),r.Q6J("disabled",!i.message_box.valid||i.force_disable))},directives:[a.Gu,a.sr,a.Sm,a.fG,a.wd,a.W2,a.jY,a.Nd,a.wI,a.q_,m.sg,a.Ie,m.O5,a.Q$,a.fr,p._Y,p.JL,p.sg,a.g2,a.j9,p.JJ,p.u,a.YG,a.gu],styles:["ion-textarea[_ngcontent-%COMP%]{max-height:70px}cdk-virtual-scroll-viewport[_ngcontent-%COMP%]{height:90%;width:100%}.fixed-outside[_ngcontent-%COMP%]{position:absolute;bottom:0;color:#fff;width:100%;height:120px;text-align:center}.has-bottom[_ngcontent-%COMP%]   .scroll[_ngcontent-%COMP%]{padding-bottom:120px!important}.button-circle[_ngcontent-%COMP%]{width:50px!important;height:50px!important;border-radius:50%!important}ion-content[_ngcontent-%COMP%]{--padding-top: 10%;--background: url(https://images.unsplash.com/photo-1536431311719-398b6704d4cc?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1234&q=80) 0 0/100% 100% no-repeat}form[_ngcontent-%COMP%]{max-width:500px;align-items:center}ion-list[_ngcontent-%COMP%]{max-width:500px}.input-group[_ngcontent-%COMP%]{background:#fff;border-radius:10px;overflow:hidden;margin-bottom:15px}.errors[_ngcontent-%COMP%]{font-size:small;color:#fff;background:var(--ion-color-danger);padding-left:15px;padding-top:5px;padding-bottom:5px}.white[_ngcontent-%COMP%]{color:#fff}"]}),n})()}];let Se=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({imports:[[v.Bz.forChild(we)],v.Bz]}),n})();new class xe extends g{flush(t){this.active=!0,this.scheduled=void 0;const{actions:e}=this;let i,o=-1,s=e.length;t=t||e.shift();do{if(i=t.execute(t.state,t.delay))break}while(++o<s&&(t=e.shift()));if(this.active=!1,i){for(;++o<s&&(t=e.shift());)t.unsubscribe();throw i}}}(class Ce extends _{constructor(t,e){super(t,e),this.scheduler=t,this.work=e}requestAsyncId(t,e,i=0){return null!==i&&i>0?super.requestAsyncId(t,e,i):(t.actions.push(this),t.scheduled||(t.scheduled=requestAnimationFrame(()=>t.flush(null))))}recycleAsyncId(t,e,i=0){if(null!==i&&i>0||null===i&&this.delay>0)return super.recycleAsyncId(t,e,i);0===t.actions.length&&(cancelAnimationFrame(e),t.scheduled=void 0)}});let Re=1;const ye=Promise.resolve(),S={};function z(n){return n in S&&(delete S[n],!0)}const F={setImmediate(n){const t=Re++;return S[t]=!0,ye.then(()=>z(t)&&n()),t},clearImmediate(n){z(n)}};new class Te extends g{flush(t){this.active=!0,this.scheduled=void 0;const{actions:e}=this;let i,o=-1,s=e.length;t=t||e.shift();do{if(i=t.execute(t.state,t.delay))break}while(++o<s&&(t=e.shift()));if(this.active=!1,i){for(;++o<s&&(t=e.shift());)t.unsubscribe();throw i}}}(class De extends _{constructor(t,e){super(t,e),this.scheduler=t,this.work=e}requestAsyncId(t,e,i=0){return null!==i&&i>0?super.requestAsyncId(t,e,i):(t.actions.push(this),t.scheduled||(t.scheduled=F.setImmediate(t.flush.bind(t,null))))}recycleAsyncId(t,e,i=0){if(null!==i&&i>0||null===i&&this.delay>0)return super.recycleAsyncId(t,e,i);0===t.actions.length&&(F.clearImmediate(e),t.scheduled=void 0)}});let M=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({}),n})(),P=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({}),n})(),Ee=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({imports:[[M,P],M,P]}),n})(),Ve=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=r.oAB({type:n}),n.\u0275inj=r.cJS({imports:[[m.ez,p.u5,a.Pc,p.UX,Se,Ee]]}),n})()}}]);